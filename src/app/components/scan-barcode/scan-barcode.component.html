<div class="scan-container">
  <!-- <app-environment-indicator></app-environment-indicator> -->
  <header class="header">
    <button class="back-btn" (click)="goBack()">← Kembali</button>
    <h1>Scan Barcode Kendaraan</h1>
    <button class="logout-btn" (click)="logout()"><i class="fi fi-br-exit" style="margin-right:6px;"></i>Keluar</button>
  </header>

  <main class="scan-content">
    <div class="scan-card">


      <div class="manual-input-section">

        <div class="input-group">
            <label class="input-label">Nopol Truck</label>
            <input
              type="text"
              [(ngModel)]="manualTruckPlate"
              name="truckPlate"
              placeholder="Contoh: KT8655UP"
              class="barcode-input"
              [disabled]="isLoadingTripData || isLoadingSpk"
              (ngModelChange)="onNopolChange($event)"
            />
            <div class="spk-loading" *ngIf="isLoadingSpk">
              <span class="loading-dot"></span> Mencari nomor SPK...
            </div>
          </div>

        <form (ngSubmit)="onSubmit()">
          <div class="input-group">
            <label class="input-label">Nomor SPK</label>

            <!-- Custom dropdown dengan search -->
            <div class="spk-custom-dropdown">
              <div class="spk-dropdown-selected"
                   [class.open]="spkDropdownOpen"
                   [class.disabled]="isLoadingTripData || isLoadingSpk"
                   (click)="!(isLoadingTripData || isLoadingSpk) && toggleSpkDropdown()">
                <span [class.placeholder]="!barcodeInput">
                  {{ barcodeInput || '-- Pilih Nomor SPK --' }}
                </span>
                <span class="spk-dropdown-arrow">▼</span>
              </div>
              <div class="spk-dropdown-panel" [hidden]="!spkDropdownOpen">
                <div class="spk-search-wrapper">
                  <input
                    type="text"
                    [(ngModel)]="spkSearchQuery"
                    name="spkSearch"
                    placeholder="Cari nomor SPK..."
                    class="spk-search-input"
                    (click)="$event.stopPropagation()"
                  />
                </div>
                <div class="spk-options-list">
                  <div
                    *ngFor="let spk of filteredSpkOptions"
                    class="spk-option"
                    [class.selected]="barcodeInput === spk"
                    (click)="selectSpk(spk)"
                  >
                    {{ spk }}
                  </div>
                  <div class="spk-no-result" *ngIf="filteredSpkOptions.length === 0">
                    {{ spkOptions.length === 0 ? 'Isi nopol truck terlebih dahulu' : 'Tidak ditemukan' }}
                  </div>
                </div>
              </div>
            </div>

            <div class="input-validation" *ngIf="barcodeInput.trim()">
              <span
                class="validation-icon"
                [class.valid]="isValidBarcodeInput()"
                [class.invalid]="!isValidBarcodeInput()"
              >
                {{ isValidBarcodeInput() ? '✅' : '❌' }}
              </span>
              <span class="validation-text">
                {{ isValidBarcodeInput() ? 'Format valid' : 'Format tidak valid'  }}
              </span>
            </div>
          </div>
          
          <!-- Loading State -->
          <div class="loading-section" *ngIf="isLoadingTripData">
            <div class="loading-spinner"></div>
            <p class="loading-text">Mengambil data perjalanan...</p>
          </div>
          
          <!-- Error Message -->
          <div class="error-alert" *ngIf="errorMessage">
            <div class="error-content">
              <span class="error-icon">❌</span>
              <div class="error-text">
                <h4>{{ errorTitle }}</h4>
                <p>{{ errorMessage }}</p>
              </div>
              <button class="error-close" (click)="clearError()">×</button>
            </div>
          </div>
          
          <button 
            type="submit" 
            class="submit-btn"
            [disabled]="isLoadingTripData || !barcodeInput.trim()"
          >
            {{ isLoadingTripData ? 'Memuat...' : 'Ambil Data Perjalanan' }}
          </button>
        </form>
      </div>
    </div>
  </main>
</div>
