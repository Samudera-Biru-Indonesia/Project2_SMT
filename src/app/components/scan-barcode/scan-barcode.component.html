<div class="scan-container">
  <app-environment-indicator></app-environment-indicator>
  <header class="header">
    <button class="back-btn" (click)="goBack()">‚Üê Kembali</button>
    <h1>Scan Barcode Kendaraan</h1>
  </header>

  <main class="scan-content">
    <div class="scan-card">
      <div class="scanner-section">
        <div class="scanner-frame" [class.scanning]="isScanning">
          <!-- Camera Video Element -->
          <video 
            #videoElement 
            *ngIf="isScanning && hasCamera" 
            autoplay 
            playsinline
            class="scanner-video">
          </video>
          
          <!-- Scanner Overlay -->
          <div class="scanner-line" *ngIf="isScanning"></div>
          <div class="scanner-corners">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
          </div>
          
          <!-- Scanner Content (when not scanning) -->
          <div class="scanner-content" *ngIf="!isScanning">
            <span class="scanner-icon">üì±</span>
            <p *ngIf="!hasCamera" class="camera-error">{{ cameraError }}</p>
          </div>
          
          <!-- Scanning Status -->
          <div class="scanner-status" *ngIf="isScanning">
            <span class="scanning-text">üîç Mencari barcode...</span>
            <p class="scan-instruction">Arahkan kamera ke barcode</p>
          </div>
        </div>
        
        <div class="scanner-controls">
          <button 
            class="scan-btn" 
            (click)="startScan()"
            [disabled]="isScanning || !hasCamera"
            *ngIf="!isScanning"
          >
            {{ hasCamera ? 'Mulai Scan Kamera' : 'Kamera Tidak Tersedia' }}
          </button>
          
          <button 
            class="stop-btn" 
            (click)="stopScanning()"
            *ngIf="isScanning"
          >
            Berhenti Scan
          </button>
          
          <!-- Manual Input Toggle Button -->
          <button 
            class="manual-toggle-btn" 
            (click)="toggleManualInput()"
            [disabled]="isScanning"
          >
            {{ showManualInput ? 'Sembunyikan Input Manual' : 'Masukkan Barcode Manual' }}
          </button>
        </div>
        
        <!-- Camera Error Message -->
        <div class="error-message" *ngIf="cameraError">
          <span class="error-icon">‚ö†Ô∏è</span>
          <p>{{ cameraError }}</p>
          <small>Silakan gunakan input manual di bawah</small>
        </div>
      </div>

      <div class="divider" *ngIf="showManualInput">
        <span>ATAU</span>
      </div>

      <div class="manual-input-section" *ngIf="showManualInput">

        <div class="input-group">
          <label class="input-label">Nopol Truck</label>
          <div class="nopol-custom-dropdown">
            <div class="spk-dropdown-selected"
                 [class.open]="truckDropdownOpen"
                 [class.disabled]="isLoadingTripData || isLoadingSpk || trucksLoading"
                 (click)="!(isLoadingTripData || isLoadingSpk || trucksLoading) && toggleTruckDropdown()">
              <span [class.placeholder]="!manualTruckPlate">
                {{ manualTruckPlate || (trucksLoading ? 'Memuat data truck...' : '-- Pilih Nopol Truck --') }}
              </span>
              <span class="spk-dropdown-arrow">‚ñº</span>
            </div>
            <div class="spk-dropdown-panel" [hidden]="!truckDropdownOpen">
              <div class="spk-search-wrapper">
                <input
                  type="text"
                  [(ngModel)]="truckSearchQuery"
                  name="truckSearch"
                  placeholder="Cari nopol atau nama truck..."
                  class="spk-search-input"
                  (click)="$event.stopPropagation()"
                />
              </div>
              <div class="spk-options-list">
                <div
                  *ngFor="let truck of filteredTruckOptions"
                  class="spk-option"
                  [class.selected]="manualTruckPlate === truck.truckPlate"
                  (click)="selectTruck(truck)"
                >
                  <span class="truck-plate">{{ truck.truckPlate }}</span>
                  <span class="truck-desc" *ngIf="truck.truckDesc"> ‚Äî {{ truck.truckDesc }}</span>
                </div>
                <div class="spk-no-result" *ngIf="filteredTruckOptions.length === 0">
                  {{ trucks.length === 0 ? 'Tidak ada data truck' : 'Tidak ditemukan' }}
                </div>
              </div>
            </div>
          </div>
          <div class="spk-loading" *ngIf="isLoadingSpk">
            <span class="loading-dot"></span> Mencari nomor SPK...
          </div>
        </div>

        <form (ngSubmit)="onSubmit()">
          <div class="input-group">
            <label class="input-label">Nomor SPK</label>

            <!-- Custom dropdown dengan search -->
            <div class="spk-custom-dropdown">
              <div class="spk-dropdown-selected"
                   [class.open]="spkDropdownOpen"
                   [class.disabled]="isLoadingTripData || isLoadingSpk"
                   (click)="!(isLoadingTripData || isLoadingSpk) && toggleSpkDropdown()">
                <span [class.placeholder]="!barcodeInput">
                  {{ barcodeInput || '-- Pilih Nomor SPK --' }}
                </span>
                <span class="spk-dropdown-arrow">‚ñº</span>
              </div>
              <div class="spk-dropdown-panel" [hidden]="!spkDropdownOpen">
                <div class="spk-search-wrapper">
                  <input
                    type="text"
                    [(ngModel)]="spkSearchQuery"
                    name="spkSearch"
                    placeholder="Cari nomor SPK..."
                    class="spk-search-input"
                    (click)="$event.stopPropagation()"
                  />
                </div>
                <div class="spk-options-list">
                  <div
                    *ngFor="let spk of filteredSpkOptions"
                    class="spk-option"
                    [class.selected]="barcodeInput === spk"
                    (click)="selectSpk(spk)"
                  >
                    {{ spk }}
                  </div>
                  <div class="spk-no-result" *ngIf="filteredSpkOptions.length === 0">
                    {{ spkOptions.length === 0 ? 'Isi nopol truck terlebih dahulu' : 'Tidak ditemukan' }}
                  </div>
                </div>
              </div>
            </div>

            <div class="input-validation" *ngIf="barcodeInput.trim()">
              <span
                class="validation-icon"
                [class.valid]="isValidBarcodeInput()"
                [class.invalid]="!isValidBarcodeInput()"
              >
                {{ isValidBarcodeInput() ? '‚úÖ' : '‚ùå' }}
              </span>
              <span class="validation-text">
                {{ isValidBarcodeInput() ? 'Format valid' : 'Format tidak valid'  }}
              </span>
            </div>
          </div>
          
          <!-- Loading State -->
          <div class="loading-section" *ngIf="isLoadingTripData">
            <div class="loading-spinner"></div>
            <p class="loading-text">Mengambil data perjalanan...</p>
          </div>
          
          <!-- Error Message -->
          <div class="error-alert" *ngIf="errorMessage">
            <div class="error-content">
              <span class="error-icon">‚ùå</span>
              <div class="error-text">
                <h4>{{ errorTitle }}</h4>
                <p>{{ errorMessage }}</p>
              </div>
              <button class="error-close" (click)="clearError()">√ó</button>
            </div>
          </div>
          
          <button 
            type="submit" 
            class="submit-btn"
            [disabled]="isLoadingTripData || !barcodeInput.trim()"
          >
            {{ isLoadingTripData ? 'Memuat...' : 'Ambil Data Perjalanan' }}
          </button>
        </form>
      </div>
    </div>
  </main>
</div>
