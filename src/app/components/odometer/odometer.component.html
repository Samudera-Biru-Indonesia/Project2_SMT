<div class="odometer-container">
  <!-- <app-environment-indicator></app-environment-indicator> -->
  <header class="header">
    <button class="back-btn" (click)="goBack()">← Kembali</button>
    <h1>Pembacaan Odometer</h1>
    <button class="logout-btn" (click)="logout()"><i class="fi fi-br-exit" style="margin-right:6px;"></i>Keluar</button>
  </header>

  <main class="odometer-content">
    <div class="odometer-card" [class]="tripType.toLowerCase() + '-trip'">
      <!-- Trip Header Info -->
      <div class="trip-header-info">
        <div class="trip-number-display">
          <span class="trip-label">Nomor SPK:</span>
          <span class="trip-value">{{ tripNumber }}</span>
        </div>
        <div class="plate-number-display">
          <span class="plate-label">Plat Nomor:</span>
          <span class="plate-value">{{ plateNumber }}</span>
        </div>
        <div class="driver-display">
          <span class="driver-label">Driver:</span>
          <span class="driver-value">{{ tripDriver || '-' }}</span>
        </div>
      </div>

      <!-- Order Details (hanya OUT trip) -->
      <div class="order-details-section" *ngIf="tripType === 'OUT' && orderDetails.length > 0">
        <h3 class="order-details-title">Detail Order</h3>
        <div class="order-table-wrapper">
          <table class="order-table">
            <thead>
              <tr>
                <th>No. Order</th>
                <th>Customer</th>
                <th>Qty</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let order of orderDetails">
                <td>{{ order.orderNum }}</td>
                <td>{{ order.customerName }}</td>
                <td>{{ order.totalQty }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="2"><strong>Total</strong></td>
                <td><strong>{{ expectedMuatan }}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <form (ngSubmit)="onSubmit()" class="odometer-form">
        <div class="form-section">
          <div class="form-group">
            <label for="odometer" class="required" style="margin-right:10px;">Pembacaan Odometer (KM)</label>
            @if (tripType === 'IN') {
              <label style="color:#616161;">
                Odometer sebelumnya adalah 
                @if (odometerFromDb) {
                  {{ odometerFromDb }} km.
                } @else {
                  <b>tidak diketahui.</b>
                }
              </label>
            }
            
            <input
              type="number"
              id="odometer"
              [(ngModel)]="odometerReading"
              (ngModelChange)="onOdometerChange()"
              name="odometerReading"
              placeholder="Masukkan pembacaan odometer saat ini"
              class="odometer-input"
              [class.input-error]="isOdometerWrong || odometerMismatchWarning"
              min="0"
              step="0.1"
              required
              autocomplete="off"
            />
            <div class="muatan-warning" *ngIf="odometerMismatchWarning && !showOdometerWarning">
              Odometer lebih kecil dari saat keluar. <br>
              Saat keluar: <b>{{ odometerFromDb }} km</b>
              <br>
              Nilai Anda: <b>{{ odometerReading }} km</b>
            </div>
          </div>

          <!-- Foto Odometer -->
          <div class="form-group">
            <label class="required">Foto Odometer</label>
            <div class="photo-section">
              <div class="photo-actions">
                <label class="photo-btn camera-btn" style="color: white;">
                  Kamera
                  <input type="file" accept="image/*" multiple (change)="onPhotoSelected($event, 'odometer')" hidden />
                </label>
              </div>
              
              <div class="photo-preview-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                <div *ngFor="let photo of odometerPhotos; let i = index" class="photo-item" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <img [src]="photo" class="photo-preview" style="max-width: 120px; border-radius: 8px; object-fit: cover;" />
                  <!-- <button type="button" class="remove-photo-btn" style="width: 100%; padding: 4px;" (click)="removePhoto('odometer', i)">Hapus</button> -->
                  <button type="button" class="remove-badge" (click)="removePhoto('odometer', i)">×</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Foto Muatan -->
          <div class="form-group">
            <label class="required">Foto Muatan</label>
            <div class="photo-section">
              <div class="photo-actions">
                <label class="photo-btn camera-btn" style="color: white;">
                  Kamera
                  <input type="file" accept="image/*" multiple capture="environment" (change)="onPhotoSelected($event, 'cargo')" hidden />
                </label>
              </div>
              
              <div class="photo-preview-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                <div *ngFor="let photo of cargoPhotos; let i = index" class="photo-item" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <img [src]="photo" class="photo-preview" style="max-width: 120px; border-radius: 8px; object-fit: cover;" />
                  <!-- <button type="button" class="remove-photo-btn" style="width: 100%; padding: 4px;" (click)="removePhoto('cargo', i)">Hapus</button> -->
                  <button type="button" class="remove-badge" (click)="removePhoto('cargo', i)">×</button>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="jumlah-muatan" class="required">
              Jumlah Muatan:
              <span class="expected-muatan" *ngIf="muatanType === 'CYLINDER' && expectedMuatan !== null">
                (Sistem: {{ expectedMuatan }} cylinder)
              </span>
            </label>
            <input
              type="number"
              id="jumlah-muatan"
              [(ngModel)]="jumlahMuatan"
              (ngModelChange)="onMuatanChange()"
              name="jumlahMuatan"
              placeholder="Masukkan hasil perhitungan jumlah muatan"
              class="odometer-input"
              [class.input-error]="muatanMismatchWarning || showMuatanLowWarning"
              min="0"
              step="0.1"
              required
              autocomplete="off"
            />
            <div class="muatan-warning" *ngIf="muatanMismatchWarning && !showMuatanLowWarning">
              Jumlah muatan tidak sesuai dengan sistem. <br>
              Di sistem: <b>{{ expectedMuatan }}</b> cylinder
              <br>
              Nilai Anda: <b>{{ jumlahMuatan }}</b> cylinder
            </div>
          </div>

          <div class="form-group">
            <label for="notes" [class.required]="muatanMismatchWarning">
              Catatan Tambahan
              <span *ngIf="!muatanMismatchWarning" style="font-weight:400; color:#6c757d;"> (Opsional)</span>
              <span *ngIf="muatanMismatchWarning" style="font-weight:400; color:#dc3545;"> — wajib diisi jika muatan berbeda</span>
            </label>
            <textarea
              id="notes"
              [(ngModel)]="notes"
              name="notes"
              placeholder="Masukkan catatan atau pengamatan tambahan"
              class="textarea-input"
              [class.input-error]="muatanMismatchWarning && !notes"
              rows="4"
              autocomplete="off"
            ></textarea>
          </div>
        </div>

        <div class="photo-upload-warning" *ngIf="photoUploadWarning">
          ⚠️ {{ photoUploadWarning }}
        </div>

        <div class="form-actions">
          <button type="submit"
                  class="complete-btn"
                  [ngStyle]="getButtonStyle()"
                  [disabled]="isUploading">
            {{ isUploading ? 'Mengirim...' : 'Selesaikan Registrasi Perjalanan' }}
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading || isUploading">
    <div class="loading-spinner"></div>
    <p class="loading-text">{{ isUploading ? 'Mengirim data...' : 'Memuat data order...' }}</p>
  </div>

  <!-- Modal: Peringatan Odometer -->
  <div class="modal-overlay" *ngIf="showOdometerWarning">
    <div class="modal-alert">
      <div class="modal-icon">⚠️</div>
      <h3 class="modal-title">Nilai Odometer Lebih Kecil</h3>
      <p class="modal-message">
        Nilai Saat Keluar: <b>{{ odometerFromDb }} km</b> <br> Nilai Anda Sekarang: <b>{{ odometerReading }} km</b>
      </p>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" (click)="dismissOdometerWarning()">Kembali & Perbaiki</button>
        <!-- <button class="modal-btn modal-btn-confirm" (click)="confirmOdometerWarning()">Tetap Lanjutkan</button> -->
      </div>
    </div>
  </div>

  <!-- Modal: Peringatan Jumlah Muatan Lebih Besar -->
  <div class="modal-overlay" *ngIf="showMuatanHighWarning">
    <div class="modal-alert">
      <div class="modal-icon">⚠️</div>
      <h3 class="modal-title">Jumlah Muatan Lebih Besar</h3>
      <p class="modal-message">
        Di sistem: <b>{{ expectedMuatan }}</b> cylinder
        <br>
        Nilai Anda: <b>{{ jumlahMuatan }}</b> cylinder
      </p>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" (click)="dismissMuatanHighWarning()">Perbaiki</button>
        <button class="modal-btn modal-btn-confirm" (click)="confirmMuatanHighWarning()">Tetap Lanjutkan</button>
      </div>
    </div>
  </div>

  <!-- Modal: Peringatan Jumlah Muatan Lebih Kecil -->
  <div class="modal-overlay" *ngIf="showMuatanLowWarning">
    <div class="modal-alert">
      <div class="modal-icon">⚠️</div>
      <h3 class="modal-title">Jumlah Muatan Lebih Kecil</h3>
      <p class="modal-message">
        Di sistem: <b>{{ expectedMuatan }}</b> cylinder
        <br>
        Nilai Anda: <b>{{ jumlahMuatan }}</b> cylinder
      </p>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" (click)="dismissMuatanWarning()">Perbaiki</button>
        <button class="modal-btn modal-btn-confirm" (click)="confirmMuatanWarning()">Tetap Lanjutkan</button>
      </div>
    </div>
  </div>
</div>
